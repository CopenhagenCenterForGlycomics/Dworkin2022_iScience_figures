# Figure4CDE generation

```{r}
library(ggplot2)
```

# Tabula 9606 isoenzyme expression

```{r load, eval=!file.exists('glycogene_pseudobulkpresence.Rds')}
filepath.char <- 'alldata_pseudobulkpresence.Rds'
gene_expression.df <- readRDS(filepath.char)
```

```{r, eval=!file.exists('glycogene_pseudobulkpresence.Rds')}
# filtering for clusters of adequate size, annotation, and expression ----
source('filtering.R')
gene_expression.df <- filtering(gene_expression.df, taxon_id = '9606', glycogenes_only = T, other_genes = 'DAG1', gte200 = F, annotated = T)
saveRDS(gene_expression.df, 'glycogene_pseudobulkpresence.Rds')
remove(gene_expression.df)
```

```{r}
gene_expression.df <- readRDS('glycogene_pseudobulkpresence.Rds')
gene_expression.df <- gene_expression.df[with(gene_expression.df, cellnum >= 200),]
gene_expression.df$germ_layer <- 'annotated'
germ_layer.char <- 'annotated'
```

# FUNCTIONS

```{r}
source('expression_functions.R')
```

```{r}
germ_layer_epitope_combinatorics
```

```{r}
pathway_expression_combinatoric_bespoke
```

# MAIN

# constructing isoenzyme family dataset for all annotated clusters

```{r}
# global args ----
pattern.vec <- c(
  '^st3gal',
  '^st6gal[^n]',
  '^st8sia',
  '^st6galnac',
  '^mgat4',
  '^b4galnt3|b4galnt4',
  '^galnt([127]|1[01])$',
  '^tmtc',
  '^b3gnt[234789]',
  '^b4galt[1234]',
  '^dpy19l[1234]',
  '^(chpf|chpf2|chsy[13]|csgalnact[12])',
  '^hs6st[123]',
  '^ndst[1234]',
  '^hs3st([1246]|3[ab])',
  '^chst1[12345]',
  '^(ext[12]|extl[123])',
  '^chst[24567]',
  '^fut([345679]|1[01])',
  '^galnt([0-9].*|L[56])$')
```

```{r}
prefix.vec <- toupper(c(
  'st3gal.',
  'st6gal.',
  'st8sia.',
  'st6galnac.',
  'mgat4.',
  'b4galnt.',
  'galnt.',
  'tmtc.',
  'b3gnt.',
  'b4galt.',
  'dpy19l.',
  'chpf.',
  'hs6st.',
  'ndst.',
  'hs3st.',
  'chst1.',
  'ext.',
  'chst.',
  'fut.',
  'galnts.'))
```

```{r}

annotated_isoenzyme.list <- list(
  st3gal.df    = gene_expression.df[with(gene_expression.df, gene %in% grep(pattern.vec[1], unique(gene), value = T, ignore.case = T)),],
  st6gal.df    = gene_expression.df[with(gene_expression.df, gene %in% grep(pattern.vec[2], unique(gene), value = T, ignore.case = T)),],
  st8sia.df    = gene_expression.df[with(gene_expression.df, gene %in% grep(pattern.vec[3], unique(gene), value = T, ignore.case = T)),],
  st6galnac.df = gene_expression.df[with(gene_expression.df, gene %in% grep(pattern.vec[4], unique(gene), value = T, ignore.case = T)),],
  mgat4.df     = gene_expression.df[with(gene_expression.df, gene %in% grep(pattern.vec[5], unique(gene), value = T, ignore.case = T)),],
  b4galnt.df   = gene_expression.df[with(gene_expression.df, gene %in% grep(pattern.vec[6], unique(gene), value = T, ignore.case = T)),],
  galnt.df     = gene_expression.df[with(gene_expression.df, gene %in% grep(pattern.vec[7], unique(gene), value = T, ignore.case = T)),],
  tmtc.df      = gene_expression.df[with(gene_expression.df, gene %in% grep(pattern.vec[8], unique(gene), value = T, ignore.case = T)),],
  b3gnt.df     = gene_expression.df[with(gene_expression.df, gene %in% grep(pattern.vec[9], unique(gene), value = T, ignore.case = T)),],
  b4galt.df    = gene_expression.df[with(gene_expression.df, gene %in% grep(pattern.vec[10], unique(gene), value = T, ignore.case = T)),],
  dpy19l.df    = gene_expression.df[with(gene_expression.df, gene %in% grep(pattern.vec[11], unique(gene), value = T, ignore.case = T)),],
  chpf.df      = gene_expression.df[with(gene_expression.df, gene %in% grep(pattern.vec[12], unique(gene), value = T, ignore.case = T)),],
  hs6st.df     = gene_expression.df[with(gene_expression.df, gene %in% grep(pattern.vec[13], unique(gene), value = T, ignore.case = T)),],
  ndst.df      = gene_expression.df[with(gene_expression.df, gene %in% grep(pattern.vec[14], unique(gene), value = T, ignore.case = T)),],
  hs3st.df     = gene_expression.df[with(gene_expression.df, gene %in% grep(pattern.vec[15], unique(gene), value = T, ignore.case = T)),],
  chst1.df     = gene_expression.df[with(gene_expression.df, gene %in% grep(pattern.vec[16], unique(gene), value = T, ignore.case = T)),],
  ext.df       = gene_expression.df[with(gene_expression.df, gene %in% grep(pattern.vec[17], unique(gene), value = T, ignore.case = T)),],
  chst.df      = gene_expression.df[with(gene_expression.df, gene %in% grep(pattern.vec[18], unique(gene), value = T, ignore.case = T)),],
  fut.df       = gene_expression.df[with(gene_expression.df, gene %in% grep(pattern.vec[19], unique(gene), value = T, ignore.case = T)),],
  galnts.df    = gene_expression.df[with(gene_expression.df, gene %in% grep(pattern.vec[20], unique(gene), value = T, ignore.case = T)),])

```

# Figure4D 

```{r annotated_isoenzyme3_bespoke, fig.height=3.5, fig.width=3.5, message=FALSE, warning=FALSE}

pathway_expression_combinatoric_bespoke(as.list(setNames(stringr::str_sort(unique(annotated_isoenzyme.list[[3]]$gene), numeric = TRUE), paste0(prefix.vec[3], stringr::str_sort(unique(annotated_isoenzyme.list[[3]]$gene), numeric = TRUE)))), annotated_isoenzyme.list[[3]], 1, 'ST8SIA4', 'exclusive_intersection')

```

```{r annotated_isoenzyme4_bespoke, fig.height=3.5, fig.width=3.5, message=FALSE, warning=FALSE}

pathway_expression_combinatoric_bespoke(as.list(setNames(stringr::str_sort(unique(annotated_isoenzyme.list[[4]]$gene), numeric = TRUE), paste0(prefix.vec[4], stringr::str_sort(unique(annotated_isoenzyme.list[[4]]$gene), numeric = TRUE)))), annotated_isoenzyme.list[[4]], 1, 'ST6GALNAC3|4', 'exclusive_intersection')

```

```{r annotated_isoenzyme7_bespoke, fig.height=3.5, fig.width=3.5, message=FALSE, warning=FALSE}

pathway_expression_combinatoric_bespoke(as.list(setNames(stringr::str_sort(unique(annotated_isoenzyme.list[[20]]$gene), numeric = TRUE), paste0(prefix.vec[20], stringr::str_sort(unique(annotated_isoenzyme.list[[20]]$gene), numeric = TRUE)))), annotated_isoenzyme.list[[20]], 1, 'GALNT1|2|3|7|10|11', 'exclusive_intersection')

```

```{r annotated_isoenzyme9_bespoke, fig.height=3.5, fig.width=3.5, message=FALSE, warning=FALSE}

pathway_expression_combinatoric_bespoke(as.list(setNames(stringr::str_sort(unique(annotated_isoenzyme.list[[9]]$gene), numeric = TRUE), paste0(prefix.vec[9], stringr::str_sort(unique(annotated_isoenzyme.list[[9]]$gene), numeric = TRUE)))), annotated_isoenzyme.list[[9]], 1, 'B3GNT2', 'exclusive_intersection')

```

```{r annotated_isoenzyme13_bespoke, fig.height=3.5, fig.width=3.5, message=FALSE, warning=FALSE}

pathway_expression_combinatoric_bespoke(as.list(setNames(stringr::str_sort(unique(annotated_isoenzyme.list[[13]]$gene), numeric = TRUE), paste0(prefix.vec[13], stringr::str_sort(unique(annotated_isoenzyme.list[[13]]$gene), numeric = TRUE)))), annotated_isoenzyme.list[[13]], 1, 'HS6ST1', 'exclusive_intersection')

```

```{r annotated_isoenzyme14_bespoke, fig.height=3.5, fig.width=3.5, message=FALSE, warning=FALSE}

pathway_expression_combinatoric_bespoke(as.list(setNames(stringr::str_sort(unique(annotated_isoenzyme.list[[14]]$gene), numeric = TRUE), paste0(prefix.vec[14], stringr::str_sort(unique(annotated_isoenzyme.list[[14]]$gene), numeric = TRUE)))), annotated_isoenzyme.list[[14]], 1, 'NDST1|2', 'exclusive_intersection')

```

```{r annotated_isoenzyme15_bespoke, fig.height=3.5, fig.width=3.5, message=FALSE, warning=FALSE}

pathway_expression_combinatoric_bespoke(as.list(setNames(stringr::str_sort(unique(annotated_isoenzyme.list[[15]]$gene), numeric = TRUE), paste0(prefix.vec[15], stringr::str_sort(unique(annotated_isoenzyme.list[[15]]$gene), numeric = TRUE)))), annotated_isoenzyme.list[[15]], 1, 'HS3ST3B1', 'exclusive_intersection')

```

```{r annotated_isoenzyme18_bespoke, fig.height=3.5, fig.width=3.5, message=FALSE, warning=FALSE}

pathway_expression_combinatoric_bespoke(as.list(setNames(stringr::str_sort(unique(annotated_isoenzyme.list[[18]]$gene), numeric = TRUE), paste0(prefix.vec[18], stringr::str_sort(unique(annotated_isoenzyme.list[[18]]$gene), numeric = TRUE)))), annotated_isoenzyme.list[[18]], 1, 'CHST2|5', 'exclusive_intersection')

```

```{r annotated_isoenzyme19_bespoke, fig.height=3.5, fig.width=3.5, message=FALSE, warning=FALSE}

pathway_expression_combinatoric_bespoke(as.list(setNames(stringr::str_sort(unique(annotated_isoenzyme.list[[19]]$gene), numeric = TRUE), paste0(prefix.vec[19], stringr::str_sort(unique(annotated_isoenzyme.list[[19]]$gene), numeric = TRUE)))), annotated_isoenzyme.list[[19]], 1, 'FUT4', 'exclusive_intersection')

```

# epitope combinatorics

```{r}
# setting up external data for computing percent of 32 select epitopes in each germ layer subset ----
epitope.df <- as.data.frame(readxl::read_xlsx('data/xlsx/epitope_combinatorics.xlsx', sheet = "lacto,globo,ganglio,core"))
```

```{r}
epitope.list <- c(

  full_intersects =
    sapply(
      sapply(
        grep('_', epitope.df$Glycosyltransferases, value = T, invert = T),
        strsplit,
        fixed = T,
        split = '|'),
      strsplit,
      fixed = T,
      split = ';', simplify = F),

  partial_intersects =
    sapply(
      sapply(
        sapply(
          sapply(
            grep('_', epitope.df$Glycosyltransferases, value = T),
            strsplit,
            fixed = T,
            split = '_'),
          `[[`,
          1),
        strsplit,
        fixed = T,
        split = '|'),
      strsplit,
      fixed = T,
      split = ';'),

  partial_outersects =
    sapply(
      sapply(
        sapply(
          sapply(
            grep('_', epitope.df$Glycosyltransferases, value = T),
            strsplit,
            fixed = T,
            split = '_'),
          `[[`,
          2),
        strsplit,
        fixed = T,
        split = '|'),
      strsplit,
      fixed = T,
      split = ';'))
```

```{r}
epitope_combinatorics.list <- c(
  germ_layer_epitope_combinatorics(
    epitope.list[grepl('full_intersects', names(epitope.list))],
    germ_layer.df = gene_expression.df),
  germ_layer_epitope_combinatorics(
    epitope.list[grepl('partial_intersects', names(epitope.list))],
    epitope.list[grepl('partial_outersects', names(epitope.list))],
    germ_layer.df = gene_expression.df))
```

```{r}
epitope.df$annotated <- unlist(lapply(epitope_combinatorics.list, attributes))
```

# Figure4D 

```{r epitope.df, message=F, warning=F}
knoter::excel('minimum_epitope_set' = epitope.df)
```

# percent expression capacity co-occurrence of epitope subsets (relative to lacNAc type 1 and type 2)

```{r }
data.df <- readxl::read_xlsx('data/xlsx/epitope_combinatorics_relative_expression.xlsx')
```

# Figure4E

```{r fig.width=7, fig.height=7}
ggplot(
  data.df,
  aes(x = Series, y = relative)) +
  geom_col() +
  facet_wrap(vars(Epitope), nrow = 4, ncol = 2, dir = 'v') +
  ylim(c(0,100)) +
  ylab('% expression capacity co-occurence (relative to lacNAc)') +
  ggtitle('epitope combinatorics') +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
